---
# SecretProviderClass for TeamVault CSI driver
#
# This example shows how to use the TeamVault Secrets Store CSI driver
# to mount secrets as files inside pod volumes.
#
# Prerequisites:
#   1. Install the Secrets Store CSI driver:
#      helm install csi-secrets-store secrets-store-csi-driver/secrets-store-csi-driver \
#        --namespace kube-system
#
#   2. Install the TeamVault CSI provider (see kubernetes/csi-driver/)
#
#   3. Create a Kubernetes secret with your TeamVault token:
#      kubectl create secret generic teamvault-creds \
#        --from-literal=token=<your-token>

apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: teamvault-secrets
  namespace: default
  labels:
    app.kubernetes.io/part-of: teamvault
spec:
  provider: teamvault
  parameters:
    # TeamVault server address
    teamvaultAddr: "https://teamvault.teamvault-system.svc:8443"

    # Project containing the secrets
    project: "my-project"

    # Secrets to mount (YAML array format)
    objects: |
      - objectName: "database/password"
        objectType: "secret"
        objectAlias: "db-password"
      - objectName: "api/stripe-key"
        objectType: "secret"
        objectAlias: "stripe-key"
      - objectName: "tls/server.crt"
        objectType: "secret"
        objectAlias: "tls-cert"
        objectEncoding: "base64"

  # Optionally sync CSI secrets to Kubernetes Secrets
  secretObjects:
    - secretName: teamvault-synced-secrets
      type: Opaque
      data:
        - objectName: db-password
          key: DATABASE_PASSWORD
        - objectName: stripe-key
          key: STRIPE_API_KEY

---
# Example pod using the SecretProviderClass
apiVersion: v1
kind: Pod
metadata:
  name: example-app
  namespace: default
spec:
  serviceAccountName: default
  containers:
    - name: app
      image: busybox:latest
      command: ["sh", "-c", "cat /mnt/secrets/db-password && sleep 3600"]
      volumeMounts:
        - name: teamvault-secrets
          mountPath: /mnt/secrets
          readOnly: true
      env:
        # Use the synced Kubernetes Secret as env vars
        - name: DATABASE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: teamvault-synced-secrets
              key: DATABASE_PASSWORD
  volumes:
    - name: teamvault-secrets
      csi:
        driver: secrets-store.csi.k8s.io
        readOnly: true
        volumeAttributes:
          secretProviderClass: teamvault-secrets
        nodePublishSecretRef:
          name: teamvault-creds
